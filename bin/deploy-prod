#!/bin/zsh

GITGUD_CREDS=`echo 'host=gitgud.io\n\n' | git credential-osxkeychain get`
GITGUD_USERNAME=`echo $GITGUD_CREDS | sed -ne 's/username=//p'`
GITGUD_PASSWORD=`echo $GITGUD_CREDS | sed -ne 's/password=//p'`

ssh -tt root@206.81.100.148 "export GITGUD_USERNAME='$GITGUD_USERNAME'; export GITGUD_PASSWORD=$GITGUD_PASSWORD; bash" << 'ENDSSH'
cd prod

echo https://$GITGUD_USERNAME:$GITGUD_PASSWORD@gitgud.io >> ~/.git-credentials
git pull
rm ~/.git-credentials

npm install

NODE_ENV=production npx sequelize db:migrate

# Restart the server
pkill -f NODE_ENV=production pm2 /root/prod/bin/www
screen -S prod -X stuff 'cd /root/prod\n'
screen -S prod -X stuff 'NODE_ENV=production pm2 /root/prod/bin/www\n'

exit
ENDSSH

# Note to restart server:
# screen -r prod
# (Press Ctrl-C) or run `pkill -f /root/prod/bin/www`
# node /root/prod/bin/www
# (To detach from screen press Ctrl-A then Ctrl-D)
# (If prod screen not there, you can start one with screen -R prod)