#!/bin/zsh

GITGUD_CREDS=`echo 'host=gitgud.io\n\n' | git credential-osxkeychain get`
GITGUD_USERNAME=`echo $GITGUD_CREDS | sed -ne 's/username=//p'`
GITGUD_PASSWORD=`echo $GITGUD_CREDS | sed -ne 's/password=//p'`

ssh -tt root@206.81.100.148 "export GITGUD_USERNAME='$GITGUD_USERNAME'; export GITGUD_PASSWORD=$GITGUD_PASSWORD; bash" << 'ENDSSH'
cd prod

echo https://$GITGUD_USERNAME:$GITGUD_PASSWORD@gitgud.io >> ~/.git-credentials
git pull
rm ~/.git-credentials

npm install

NODE_ENV=production npx sequelize db:migrate

# Restart the server
pm2 restart pluribus

exit
ENDSSH

# Note: if starting from scratch, in order for Git credentials to work you need to run:
# git config credential.helper store

# Note to restart server:
# screen -r prod
#
# Run one of these to see what the pm2 process is doing:
# pm2 show pluribus
# -or-
# pm2 list
# 
# If you need to start a new pm2 process:
# NODE_ENV=production PORT=3001 pm2 start /root/prod/bin/www  --name pluribus
#
# Or, if you need to restart the existing pm2 process:
# pm2 restart pluribus
# 
# (To detach from screen press Ctrl-A then Ctrl-D)
# (If prod screen not there, you can start one with screen -R prod)